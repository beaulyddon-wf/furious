<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>test_context.py</title>
  <link rel="stylesheet" href="../../../../pycco.css">
  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <script type="text/javascript" charset="utf-8">
    var slide_it = function( main, details )
    {
        main = "#".concat( main );
        details = "#".concat( details );
        $(main).click( function() {
            if ( $( details ).is( ':hidden' ) ) {
                $( main ).addClass( "active" );
                $( details ).slideDown( 'fast' );
            }
            else {
                $( details ).slideUp( 'fast' );
                $( main ).removeClass( "active" );
            }
        });
    };
</script>
</head>
<body>
<div id="background"></div>
<div id='container'>

  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">

            <div id="1" >
              <a class="source" id="pathname"> furious </a>
            </div>

            <div id="1_titles" style="display: none;">
                <a class="source" id="filename" href="../../__init__.html"> __init__.py </a>
                <a class="source" id="filename" href="../../async.html"> async.py </a>
                <a class="source" id="filename" href="../../batcher.html"> batcher.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "1",
                          "1_titles" );
              </script>
            <div id="2" >
              <a class="source" id="pathname"> furious/context </a>
            </div>

            <div id="2_titles" style="display: none;">
                <a class="source" id="filename" href="../../context/__init__.html"> __init__.py </a>
                <a class="source" id="filename" href="../../context/_execution.html"> _execution.py </a>
                <a class="source" id="filename" href="../../context/_local.html"> _local.py </a>
                <a class="source" id="filename" href="../../context/context.html"> context.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "2",
                          "2_titles" );
              </script>
            <div id="3" >
              <a class="source" id="pathname"> furious/handlers </a>
            </div>

            <div id="3_titles" style="display: none;">
                <a class="source" id="filename" href="../../handlers/__init__.html"> __init__.py </a>
                <a class="source" id="filename" href="../../handlers/webapp.html"> webapp.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "3",
                          "3_titles" );
              </script>
            <div id="4" >
              <a class="source" id="pathname"> furious </a>
            </div>

            <div id="4_titles" style="display: none;">
                <a class="source" id="filename" href="../../job_utils.html"> job_utils.py </a>
                <a class="source" id="filename" href="../../processors.html"> processors.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "4",
                          "4_titles" );
              </script>
            <div id="5" >
              <a class="source" id="pathname"> furious/tests </a>
            </div>

            <div id="5_titles" style="display: none;">
                <a class="source" id="filename" href="../__init__.html"> __init__.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "5",
                          "5_titles" );
              </script>
            <div id="6" >
              <a class="source" id="pathname"> furious/tests/context </a>
            </div>

            <div id="6_titles" style="display: none;">
                <a class="source" id="filename" href="./__init__.html"> __init__.py </a>
                <a class="source" id="filename" href="./test_context.html"> test_context.py </a>
                <a class="source" id="filename" href="./test_execution_context.html"> test_execution_context.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "6",
                          "6_titles" );
              </script>
            <div id="7" >
              <a class="source" id="pathname"> furious/tests </a>
            </div>

            <div id="7_titles" style="display: none;">
                <a class="source" id="filename" href="../test_async.html"> test_async.py </a>
                <a class="source" id="filename" href="../test_batcher.html"> test_batcher.py </a>
                <a class="source" id="filename" href="../test_job_utils.html"> test_job_utils.py </a>
                <a class="source" id="filename" href="../test_processors.html"> test_processors.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "7",
                          "7_titles" );
              </script>

      </div>
    </div>
  </div>

  <div class='section'>
    <div class='docs'><h1>test_context.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>Copyright 2012 WebFilings, LLC</p>
<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<p>http://www.apache.org/licenses/LICENSE-2.0</p>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">testbed</span>

<span class="kn">from</span> <span class="nn">mock</span> <span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">from</span> <span class="nn">mock</span> <span class="kn">import</span> <span class="n">patch</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Test that new returns a new context and adds it to the registry.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">TestNew</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Ensure new returns a new context.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_new</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>
        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">new</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">new</span><span class="p">(),</span> <span class="n">Context</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Ensure new adds new contexts to the context registry.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_new_adds_to_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>
        <span class="kn">from</span> <span class="nn">furious.context._local</span> <span class="kn">import</span> <span class="n">get_local_context</span>
        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">new</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">new</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">Context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">get_local_context</span><span class="p">()</span><span class="o">.</span><span class="n">registry</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Test that the Context object functions in some basic way.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">TestContext</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">uuid</span>

        <span class="n">harness</span> <span class="o">=</span> <span class="n">testbed</span><span class="o">.</span><span class="n">Testbed</span><span class="p">()</span>
        <span class="n">harness</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="n">harness</span><span class="o">.</span><span class="n">init_taskqueue_stub</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>Ensure each test looks like it is in a new request.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;REQUEST_ID_HASH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Ensure using a Context as a context manager works.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_context_works</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="k">with</span> <span class="n">Context</span><span class="p">():</span>
            <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Ensure Contexts require a callable insert_tasks function.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_context_requires_insert_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">Context</span><span class="p">,</span> <span class="n">insert_tasks</span><span class="o">=</span><span class="s">&#39;nope&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Ensure a new Context gets an id generated.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_context_gets_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Context</span><span class="p">()</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Ensure a new Context keeps its assigned id.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_context_gets_assigned_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;test_id_weee&#39;</span><span class="p">,</span> <span class="n">Context</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s">&#39;test_id_weee&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Ensure adding a job works.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@patch</span><span class="p">(</span><span class="s">&#39;google.appengine.api.taskqueue.Queue.add&#39;</span><span class="p">,</span> <span class="n">auto_spec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_add_job_to_context_works</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_add_mock</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.async</span> <span class="kn">import</span> <span class="n">Async</span>
        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="k">with</span> <span class="n">Context</span><span class="p">()</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">Async</span><span class="p">)</span>
        <span class="n">queue_add_mock</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Ensure exceptions cause tasks to not insert.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@patch</span><span class="p">(</span><span class="s">&#39;google.appengine.api.taskqueue.Queue.add&#39;</span><span class="p">,</span> <span class="n">auto_spec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_bubbling_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_add_mock</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Testing generated error.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">class</span> <span class="nc">TestError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">Context</span><span class="p">()</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
                <span class="k">raise</span> <span class="n">TestError</span><span class="p">(</span><span class="s">&#39;ka pow&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">TestError</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">queue_add_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Ensure adding a job works.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@patch</span><span class="p">(</span><span class="s">&#39;google.appengine.api.taskqueue.Queue.add&#39;</span><span class="p">,</span> <span class="n">auto_spec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_nested_context_works</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_add_mock</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.async</span> <span class="kn">import</span> <span class="n">Async</span>
        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="k">with</span> <span class="n">Context</span><span class="p">()</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">Context</span><span class="p">()</span> <span class="k">as</span> <span class="n">ctx2</span><span class="p">:</span>
                <span class="n">job2</span> <span class="o">=</span> <span class="n">ctx2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">Async</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">job2</span><span class="p">,</span> <span class="n">Async</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">queue_add_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Ensure adding multiple jobs works.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@patch</span><span class="p">(</span><span class="s">&#39;google.appengine.api.taskqueue.Queue.add&#39;</span><span class="p">,</span> <span class="n">auto_spec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_add_multiple_jobs_to_context_works</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_add_mock</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="k">with</span> <span class="n">Context</span><span class="p">()</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="n">queue_add_mock</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue_add_mock</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>Ensure jobs are added to the correct queue.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@patch</span><span class="p">(</span><span class="s">&#39;google.appengine.api.taskqueue.Queue&#39;</span><span class="p">,</span> <span class="n">auto_spec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_added_to_correct_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_mock</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="k">with</span> <span class="n">Context</span><span class="p">()</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">queue</span><span class="o">=</span><span class="s">&#39;A&#39;</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">queue</span><span class="o">=</span><span class="s">&#39;A&#39;</span><span class="p">)</span>

        <span class="n">queue_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;A&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>Ensure adding jobs to multiple queues works as expected.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_add_jobs_to_multiple_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">google.appengine.api.taskqueue</span> <span class="kn">import</span> <span class="n">Queue</span>
        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="n">queue_registry</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">class</span> <span class="nc">AwesomeQueue</span><span class="p">(</span><span class="n">Queue</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">AwesomeQueue</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="n">queue_registry</span><span class="p">[</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span> <span class="o">=</span> <span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s">&#39;google.appengine.api.taskqueue.Queue&#39;</span><span class="p">,</span> <span class="n">AwesomeQueue</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">Context</span><span class="p">()</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">queue</span><span class="o">=</span><span class="s">&#39;A&#39;</span><span class="p">)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">queue</span><span class="o">=</span><span class="s">&#39;A&#39;</span><span class="p">)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">queue</span><span class="o">=</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">queue</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue_registry</span><span class="p">[</span><span class="s">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue_registry</span><span class="p">[</span><span class="s">&#39;B&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue_registry</span><span class="p">[</span><span class="s">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>Ensure to_dict returns a dictionary representation of the Context.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">import</span> <span class="nn">copy</span>

        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;persistence_engine&#39;</span><span class="p">:</span> <span class="s">&#39;persistence_engine&#39;</span><span class="p">,</span>
            <span class="s">&#39;unkown&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="o">**</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">options</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>This stuff gets dumped out by to_dict().</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s">&#39;insert_tasks&#39;</span><span class="p">:</span> <span class="s">&#39;furious.context.context._insert_tasks&#39;</span><span class="p">,</span>
            <span class="s">&#39;_tasks_inserted&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;_task_ids&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>Ensure to_dict correctly encodes callbacks.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_to_dict_with_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">import</span> <span class="nn">copy</span>

        <span class="kn">from</span> <span class="nn">furious.async</span> <span class="kn">import</span> <span class="n">Async</span>
        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;persistence_engine&#39;</span><span class="p">:</span> <span class="s">&#39;persistence_engine&#39;</span><span class="p">,</span>
            <span class="s">&#39;callbacks&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">test_to_dict_with_callbacks</span><span class="p">,</span>
                <span class="s">&#39;failure&#39;</span><span class="p">:</span> <span class="s">&quot;failure_function&quot;</span><span class="p">,</span>
                <span class="s">&#39;exec&#39;</span><span class="p">:</span> <span class="n">Async</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="nb">dir</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="o">**</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">options</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>This stuff gets dumped out by to_dict().</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s">&#39;insert_tasks&#39;</span><span class="p">:</span> <span class="s">&#39;furious.context.context._insert_tasks&#39;</span><span class="p">,</span>
            <span class="s">&#39;persistence_engine&#39;</span><span class="p">:</span> <span class="s">&#39;persistence_engine&#39;</span><span class="p">,</span>
            <span class="s">&#39;_tasks_inserted&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;_task_ids&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s">&#39;callbacks&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;furious.tests.context.test_context.&quot;</span>
                            <span class="s">&quot;TestContext.test_to_dict_with_callbacks&quot;</span><span class="p">),</span>
                <span class="s">&#39;failure&#39;</span><span class="p">:</span> <span class="s">&quot;failure_function&quot;</span><span class="p">,</span>
                <span class="s">&#39;exec&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;job&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;dir&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)}</span>
            <span class="p">}</span>
        <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>Ensure from_dict returns the correct Context object.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="kn">from</span> <span class="nn">furious.context.context</span> <span class="kn">import</span> <span class="n">_insert_tasks</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>TODO: persistence_engine needs set to a real persistence module.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">123456</span><span class="p">,</span>
            <span class="s">&#39;insert_tasks&#39;</span><span class="p">:</span> <span class="s">&#39;furious.context.context._insert_tasks&#39;</span><span class="p">,</span>
            <span class="s">&#39;random_option&#39;</span><span class="p">:</span> <span class="s">&#39;avalue&#39;</span><span class="p">,</span>
            <span class="s">&#39;_tasks_inserted&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;_task_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
            <span class="s">&#39;persistence_engine&#39;</span><span class="p">:</span> <span class="s">&#39;furious.context.Context&#39;</span>
        <span class="p">}</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">123456</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">context</span><span class="o">.</span><span class="n">_task_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">_tasks_inserted</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;avalue&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;random_option&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">_insert_tasks</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">_insert_tasks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">_persistence_engine</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>Ensure from_dict reconstructs the Context callbacks correctly.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_from_dict_with_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;furious.tests.context.test_context.&quot;</span>
                        <span class="s">&quot;TestContext.test_to_dict_with_callbacks&quot;</span><span class="p">),</span>
            <span class="s">&#39;failure&#39;</span><span class="p">:</span> <span class="s">&quot;dir&quot;</span><span class="p">,</span>
            <span class="s">&#39;exec&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;job&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)}</span>
        <span class="p">}</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s">&#39;callbacks&#39;</span><span class="p">:</span> <span class="n">callbacks</span><span class="p">})</span>

        <span class="n">check_callbacks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="n">TestContext</span><span class="o">.</span><span class="n">test_to_dict_with_callbacks</span><span class="p">,</span>
            <span class="s">&#39;failure&#39;</span><span class="p">:</span> <span class="nb">dir</span>
        <span class="p">}</span>

        <span class="n">callbacks</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;callbacks&#39;</span><span class="p">)</span>
        <span class="n">exec_callback</span> <span class="o">=</span> <span class="n">callbacks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;exec&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">check_callbacks</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({</span><span class="s">&#39;job&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)},</span> <span class="n">exec_callback</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>Ensure to_dict(job.from_dict()) returns the same thing.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_reconstitution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">123098</span><span class="p">,</span>
            <span class="s">&#39;insert_tasks&#39;</span><span class="p">:</span> <span class="s">&#39;furious.context.context._insert_tasks&#39;</span><span class="p">,</span>
            <span class="s">&#39;persistence_engine&#39;</span><span class="p">:</span> <span class="s">&#39;furious.job_utils.get_function_path_and_options&#39;</span><span class="p">,</span>
            <span class="s">&#39;_tasks_inserted&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;_task_ids&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>Calling persist with no engine should blow up.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_persist_with_no_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">persist</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>Calling persist with an engine persists the Context.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_persist_persists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="n">persistence_engine</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">persistence_engine</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="s">&#39;persistence_engine&#39;</span>
        <span class="n">persistence_engine</span><span class="o">.</span><span class="n">im_class</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="s">&#39;engine&#39;</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">persistence_engine</span><span class="o">=</span><span class="n">persistence_engine</span><span class="p">)</span>

        <span class="n">context</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>

        <span class="n">persistence_engine</span><span class="o">.</span><span class="n">store_context</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">context</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>Calling load with an engine attempts to load the Context.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_load_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context</span> <span class="kn">import</span> <span class="n">Context</span>

        <span class="n">persistence_engine</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">persistence_engine</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="s">&#39;persistence_engine&#39;</span>
        <span class="n">persistence_engine</span><span class="o">.</span><span class="n">im_class</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="s">&#39;engine&#39;</span>
        <span class="n">persistence_engine</span><span class="o">.</span><span class="n">load_context</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="s">&#39;ABC123&#39;</span><span class="p">}</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;ABC123&#39;</span><span class="p">,</span> <span class="n">persistence_engine</span><span class="p">)</span>

        <span class="n">persistence_engine</span><span class="o">.</span><span class="n">load_context</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s">&#39;ABC123&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;ABC123&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>Test that _insert_tasks behaves as expected.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">TestInsertTasks</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">harness</span> <span class="o">=</span> <span class="n">testbed</span><span class="o">.</span><span class="n">Testbed</span><span class="p">()</span>
        <span class="n">harness</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="n">harness</span><span class="o">.</span><span class="n">init_taskqueue_stub</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>Ensure calling with an empty list doesn't blow up.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_no_tasks_doesnt_blow_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context.context</span> <span class="kn">import</span> <span class="n">_insert_tasks</span>

        <span class="n">_insert_tasks</span><span class="p">((),</span> <span class="s">&#39;A&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <p>Ensure the Queue is instantiated with the name.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@patch</span><span class="p">(</span><span class="s">&#39;google.appengine.api.taskqueue.Queue&#39;</span><span class="p">,</span> <span class="n">auto_spec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_queue_name_is_honored</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_mock</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context.context</span> <span class="kn">import</span> <span class="n">_insert_tasks</span>

        <span class="n">_insert_tasks</span><span class="p">((</span><span class="bp">None</span><span class="p">,),</span> <span class="s">&#39;AbCd&#39;</span><span class="p">)</span>
        <span class="n">queue_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;AbCd&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <p>Ensure the list of tasks are passed along.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@patch</span><span class="p">(</span><span class="s">&#39;google.appengine.api.taskqueue.Queue.add&#39;</span><span class="p">,</span> <span class="n">auto_spec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_tasks_are_passed_along</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_add_mock</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context.context</span> <span class="kn">import</span> <span class="n">_insert_tasks</span>

        <span class="n">_insert_tasks</span><span class="p">((</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;joe&#39;</span><span class="p">),</span> <span class="s">&#39;AbCd&#39;</span><span class="p">)</span>
        <span class="n">queue_add_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">((</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;joe&#39;</span><span class="p">),</span>
                                               <span class="n">transactional</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>Ensure an exception doesn't get raised from add.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@patch</span><span class="p">(</span><span class="s">&#39;google.appengine.api.taskqueue.Queue.add&#39;</span><span class="p">,</span> <span class="n">auto_spec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_task_add_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_add_mock</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context.context</span> <span class="kn">import</span> <span class="n">_insert_tasks</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">def</span> <span class="nf">raise_transient</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">taskqueue</span>
            <span class="k">raise</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">TransientError</span><span class="p">()</span>

        <span class="n">queue_add_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">raise_transient</span>

        <span class="n">_insert_tasks</span><span class="p">((</span><span class="s">&#39;A&#39;</span><span class="p">,),</span> <span class="s">&#39;AbCd&#39;</span><span class="p">)</span>
        <span class="n">queue_add_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">((</span><span class="s">&#39;A&#39;</span><span class="p">,),</span> <span class="n">transactional</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>Ensure a batches get split and retried on errors.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@patch</span><span class="p">(</span><span class="s">&#39;google.appengine.api.taskqueue.Queue.add&#39;</span><span class="p">,</span> <span class="n">auto_spec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_batches_get_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_add_mock</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">furious.context.context</span> <span class="kn">import</span> <span class="n">_insert_tasks</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">def</span> <span class="nf">raise_transient</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">taskqueue</span>
            <span class="k">raise</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">TransientError</span><span class="p">()</span>

        <span class="n">queue_add_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">raise_transient</span>

        <span class="n">_insert_tasks</span><span class="p">((</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;B&#39;</span><span class="p">),</span> <span class="s">&#39;AbCd&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">queue_add_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
