<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>async.py</title>
  <link rel="stylesheet" href="../../pycco.css">
  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <script type="text/javascript" charset="utf-8">
    var slide_it = function( main, details )
    {
        main = "#".concat( main );
        details = "#".concat( details );
        $(main).click( function() {
            if ( $( details ).is( ':hidden' ) ) {
                $( main ).addClass( "active" );
                $( details ).slideDown( 'fast' );
            }
            else {
                $( details ).slideUp( 'fast' );
                $( main ).removeClass( "active" );
            }
        });
    };
</script>
</head>
<body>
<div id="background"></div>
<div id='container'>

  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">

            <div id="1" >
              <a class="source" id="pathname"> furious </a>
            </div>

            <div id="1_titles" style="display: none;">
                <a class="source" id="filename" href="./__init__.html"> __init__.py </a>
                <a class="source" id="filename" href="./async.html"> async.py </a>
                <a class="source" id="filename" href="./batcher.html"> batcher.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "1",
                          "1_titles" );
              </script>
            <div id="2" >
              <a class="source" id="pathname"> furious/context </a>
            </div>

            <div id="2_titles" style="display: none;">
                <a class="source" id="filename" href="context/__init__.html"> __init__.py </a>
                <a class="source" id="filename" href="context/_execution.html"> _execution.py </a>
                <a class="source" id="filename" href="context/_local.html"> _local.py </a>
                <a class="source" id="filename" href="context/context.html"> context.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "2",
                          "2_titles" );
              </script>
            <div id="3" >
              <a class="source" id="pathname"> furious/handlers </a>
            </div>

            <div id="3_titles" style="display: none;">
                <a class="source" id="filename" href="handlers/__init__.html"> __init__.py </a>
                <a class="source" id="filename" href="handlers/webapp.html"> webapp.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "3",
                          "3_titles" );
              </script>
            <div id="4" >
              <a class="source" id="pathname"> furious </a>
            </div>

            <div id="4_titles" style="display: none;">
                <a class="source" id="filename" href="./job_utils.html"> job_utils.py </a>
                <a class="source" id="filename" href="./processors.html"> processors.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "4",
                          "4_titles" );
              </script>
            <div id="5" >
              <a class="source" id="pathname"> furious/tests </a>
            </div>

            <div id="5_titles" style="display: none;">
                <a class="source" id="filename" href="tests/__init__.html"> __init__.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "5",
                          "5_titles" );
              </script>
            <div id="6" >
              <a class="source" id="pathname"> furious/tests/context </a>
            </div>

            <div id="6_titles" style="display: none;">
                <a class="source" id="filename" href="tests/context/__init__.html"> __init__.py </a>
                <a class="source" id="filename" href="tests/context/test_context.html"> test_context.py </a>
                <a class="source" id="filename" href="tests/context/test_execution_context.html"> test_execution_context.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "6",
                          "6_titles" );
              </script>
            <div id="7" >
              <a class="source" id="pathname"> furious/tests </a>
            </div>

            <div id="7_titles" style="display: none;">
                <a class="source" id="filename" href="tests/test_async.html"> test_async.py </a>
                <a class="source" id="filename" href="tests/test_batcher.html"> test_batcher.py </a>
                <a class="source" id="filename" href="tests/test_job_utils.html"> test_job_utils.py </a>
                <a class="source" id="filename" href="tests/test_processors.html"> test_processors.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "7",
                          "7_titles" );
              </script>

      </div>
    </div>
  </div>

  <div class='section'>
    <div class='docs'><h1>async.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>Copyright 2012 WebFilings, LLC</p>
<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<p>http://www.apache.org/licenses/LICENSE-2.0</p>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
<p>Core async task wrapper.  This module contains the <code>Async</code> class, which is</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>used to create asynchronous jobs, and a <code>defaults</code> decorator you may use to
specify default settings for a particular async task.  To use,</p>
<pre><code># Create a task.
work = Async(
    target="function.to.run",
    args=(args, for, function),
    kwargs={'keyword': arguments, 'to': target},
    task_args={"appengine": 1, "task": "kwargs"},
    queue="yourqueue"
)

# Enqueue the task.
work.start()
</code></pre>
<p><em>or</em>, set default arguments for a function:</p>
<pre><code>@defaults(task_args={"appengine": 1, "task": "kwargs"}, queue="yourqueue")
def run_me(*args, **kwargs):
    pass

# Create a task.
work = Async(
    target=run_me,
    args=(args, for, function),
    kwargs={'keyword': arguments, 'to': target},
)

# Enqueue the task.
work.start()
</code></pre>
<p>You may also update options after instantiation:</p>
<pre><code># Create a task.
work = Async(
    target="function.to.run",
    args=(args, for, function),
    kwargs={'keyword': arguments, 'to': target}
)

work.update_options(task_args={"appengine":1, "task": "kwargs"},
                    queue="yourqueue")

# Enqueue the task.
work.start()
</code></pre>
<p>The order of precedence is:
    1) options specified when calling start.
    2) options specified using update_options.
    3) options specified in the constructor.
    4) options specified by @defaults decorator.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">.job_utils</span> <span class="kn">import</span> <span class="n">decode_callbacks</span>
<span class="kn">from</span> <span class="nn">.job_utils</span> <span class="kn">import</span> <span class="n">encode_callbacks</span>
<span class="kn">from</span> <span class="nn">.job_utils</span> <span class="kn">import</span> <span class="n">get_function_path_and_options</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ASYNC_DEFAULT_QUEUE&#39;</span><span class="p">,</span> <span class="s">&#39;ASYNC_ENDPOINT&#39;</span><span class="p">,</span> <span class="s">&#39;Async&#39;</span><span class="p">,</span> <span class="s">&#39;defaults&#39;</span><span class="p">]</span>


<span class="n">ASYNC_DEFAULT_QUEUE</span> <span class="o">=</span> <span class="s">&#39;default&#39;</span>
<span class="n">ASYNC_ENDPOINT</span> <span class="o">=</span> <span class="s">&#39;/_ah/queue/async&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>This Async has not yet been executed.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">NotExecutedError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>This Async in not currently executing.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">NotExecutingError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>This Async has already been executed.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">AlreadyExecutedError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>This Async is currently executing.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">AlreadyExecutingError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>This Async needs to be aborted immediately and restarted.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">AbortAndRestart</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Async</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Make sure nothing is snuck in.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">_check_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_job</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_options</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_execution_context</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_executing</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executed</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Specify the function this async job is to execute when run.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">executed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executed</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">executing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executing</span>

    <span class="nd">@executing.setter</span>
    <span class="k">def</span> <span class="nf">executing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">executing</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AlreadyExecutedError</span><span class="p">(</span>
                <span class="s">&#39;You can not execute an executed job.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AlreadyExecutingError</span><span class="p">(</span>
                <span class="s">&#39;Job is already executing, can not set executing.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_executing</span> <span class="o">=</span> <span class="n">executing</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotExecutedError</span><span class="p">(</span>
                <span class="s">&#39;You must execute this Async before getting its result.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span>

    <span class="nd">@result.setter</span>
    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotExecutingError</span><span class="p">(</span>
                <span class="s">&#39;The Async must be executing to set its result.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executing</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executed</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_function_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;job&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_update_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">target_path</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">get_function_path_and_options</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="n">args</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_options</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;job&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Set the ExecutionContext this async is executing under.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">set_execution_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execution_context</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_context</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.context</span> <span class="kn">import</span> <span class="n">AlreadyInContextError</span>
            <span class="k">raise</span> <span class="n">AlreadyInContextError</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_execution_context</span> <span class="o">=</span> <span class="n">execution_context</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Return this async job's configuration options.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>Safely update this async job's configuration options.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">_check_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Return this async job's callback map.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;callbacks&#39;</span><span class="p">,</span> <span class="p">{})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Create and return task headers.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>TODO: Encode some options into a header here.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;headers&#39;</span><span class="p">,</span> <span class="p">{})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Return the queue the task should run in.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;queue&#39;</span><span class="p">,</span> <span class="n">ASYNC_DEFAULT_QUEUE</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>Get user-specified task kwargs.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_task_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;task_args&#39;</span><span class="p">,</span> <span class="p">{})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>Return a task object representing this async job.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">to_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">google.appengine.api.taskqueue</span> <span class="kn">import</span> <span class="n">Task</span>

        <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ASYNC_ENDPOINT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_path</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
            <span class="s">&#39;headers&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_headers</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s">&#39;payload&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()),</span>
        <span class="p">}</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_task_args</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">Task</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>Insert the task into the requested queue, 'default' if non given.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>If a TransientError is hit the task will re-insert the task.</p>
<p>If a TaskAlreadyExistsError or TombstonedTaskError is hit the task will
silently fail.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">taskqueue</span>

        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_task</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">taskqueue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_queue</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">TransientError</span><span class="p">:</span>
            <span class="n">taskqueue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_queue</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">taskqueue</span><span class="o">.</span><span class="n">TaskAlreadyExistsError</span><span class="p">,</span>
                <span class="n">taskqueue</span><span class="o">.</span><span class="n">TombstonedTaskError</span><span class="p">):</span>
            <span class="k">return</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>TODO: Return a "result" object.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>Return this async job as a dict suitable for json encoding.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">import</span> <span class="nn">copy</span>

        <span class="n">options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>JSON don't like datetimes.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">eta</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;task_args&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;eta&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eta</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">time</span>

            <span class="n">options</span><span class="p">[</span><span class="s">&#39;task_args&#39;</span><span class="p">][</span><span class="s">&#39;eta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">eta</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>

        <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;callbacks&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s">&#39;callbacks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">encode_callbacks</span><span class="p">(</span><span class="n">callbacks</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">options</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>Return an async job from a dict output by Async.to_dict.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">async</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">import</span> <span class="nn">copy</span>

        <span class="n">async_options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">async</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>JSON don't like datetimes.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">eta</span> <span class="o">=</span> <span class="n">async_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;task_args&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;eta&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eta</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

            <span class="n">async_options</span><span class="p">[</span><span class="s">&#39;task_args&#39;</span><span class="p">][</span><span class="s">&#39;eta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">eta</span><span class="p">)</span>

        <span class="n">target</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">async_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;job&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>If there are callbacks, reconstitute them.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">callbacks</span> <span class="o">=</span> <span class="n">async_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;callbacks&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="n">async_options</span><span class="p">[</span><span class="s">&#39;callbacks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decode_callbacks</span><span class="p">(</span><span class="n">callbacks</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">async_options</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>Restarts the executing Async.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>If the Async is executing, then it will reset the _executing flag, and
restart this job. This means that the job will not necessarily execute
immediately, or on the same machine, as it goes back into the queue.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotExecutingError</span><span class="p">(</span><span class="s">&quot;Must be executing to restart the job, &quot;</span>
                                    <span class="s">&quot;perhaps you want Async.start()&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_executing</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>Set default Async options on the function decorated.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">defaults</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>Note: you must pass the decorated function by reference, not as a
"path.string.to.function" for this to have any effect.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">_check_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">real_decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
        <span class="n">function</span><span class="o">.</span><span class="n">_async_options</span> <span class="o">=</span> <span class="n">options</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>Make sure no one passes something not allowed in.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="k">return</span> <span class="n">real_decorator</span>


<span class="k">def</span> <span class="nf">_check_options</span><span class="p">(</span><span class="n">options</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">assert</span> <span class="s">&#39;job&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>assert 'callbacks' not in options</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
