<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>context.py</title>
  <link rel="stylesheet" href="../../../pycco.css">
  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <script type="text/javascript" charset="utf-8">
    var slide_it = function( main, details )
    {
        main = "#".concat( main );
        details = "#".concat( details );
        $(main).click( function() {
            if ( $( details ).is( ':hidden' ) ) {
                $( main ).addClass( "active" );
                $( details ).slideDown( 'fast' );
            }
            else {
                $( details ).slideUp( 'fast' );
                $( main ).removeClass( "active" );
            }
        });
    };
</script>
</head>
<body>
<div id="background"></div>
<div id='container'>

  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">

            <div id="1" >
              <a class="source" id="pathname"> furious </a>
            </div>

            <div id="1_titles" style="display: none;">
                <a class="source" id="filename" href="../__init__.html"> __init__.py </a>
                <a class="source" id="filename" href="../async.html"> async.py </a>
                <a class="source" id="filename" href="../batcher.html"> batcher.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "1",
                          "1_titles" );
              </script>
            <div id="2" >
              <a class="source" id="pathname"> furious/context </a>
            </div>

            <div id="2_titles" style="display: none;">
                <a class="source" id="filename" href="./__init__.html"> __init__.py </a>
                <a class="source" id="filename" href="./_execution.html"> _execution.py </a>
                <a class="source" id="filename" href="./_local.html"> _local.py </a>
                <a class="source" id="filename" href="./context.html"> context.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "2",
                          "2_titles" );
              </script>
            <div id="3" >
              <a class="source" id="pathname"> furious/handlers </a>
            </div>

            <div id="3_titles" style="display: none;">
                <a class="source" id="filename" href="../handlers/__init__.html"> __init__.py </a>
                <a class="source" id="filename" href="../handlers/webapp.html"> webapp.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "3",
                          "3_titles" );
              </script>
            <div id="4" >
              <a class="source" id="pathname"> furious </a>
            </div>

            <div id="4_titles" style="display: none;">
                <a class="source" id="filename" href="../job_utils.html"> job_utils.py </a>
                <a class="source" id="filename" href="../processors.html"> processors.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "4",
                          "4_titles" );
              </script>
            <div id="5" >
              <a class="source" id="pathname"> furious/tests </a>
            </div>

            <div id="5_titles" style="display: none;">
                <a class="source" id="filename" href="../tests/__init__.html"> __init__.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "5",
                          "5_titles" );
              </script>
            <div id="6" >
              <a class="source" id="pathname"> furious/tests/context </a>
            </div>

            <div id="6_titles" style="display: none;">
                <a class="source" id="filename" href="../tests/context/__init__.html"> __init__.py </a>
                <a class="source" id="filename" href="../tests/context/test_context.html"> test_context.py </a>
                <a class="source" id="filename" href="../tests/context/test_execution_context.html"> test_execution_context.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "6",
                          "6_titles" );
              </script>
            <div id="7" >
              <a class="source" id="pathname"> furious/tests </a>
            </div>

            <div id="7_titles" style="display: none;">
                <a class="source" id="filename" href="../tests/test_async.html"> test_async.py </a>
                <a class="source" id="filename" href="../tests/test_batcher.html"> test_batcher.py </a>
                <a class="source" id="filename" href="../tests/test_job_utils.html"> test_job_utils.py </a>
                <a class="source" id="filename" href="../tests/test_processors.html"> test_processors.py </a>
            </div>

            <script type="text/javascript" charset="utf-8">
                slide_it( "7",
                          "7_titles" );
              </script>

      </div>
    </div>
  </div>

  <div class='section'>
    <div class='docs'><h1>context.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>Copyright 2012 WebFilings, LLC</p>
<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<p>http://www.apache.org/licenses/LICENSE-2.0</p>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Furious context may be used to group a collection of Async tasks together.</p>
<p>NOTE: It is generally preferable to use the higher level helper method
found in this package to instantiate contexts.</p>
<p>Usage:</p>
<pre><code>with Context() as current_context:
    # An explicitly constructed Async object may be passed in.
    async_job = Async(some_function,
                      [args, for, other],
                      {'kwargs': 'for', 'other': 'function'},
                      queue='workgroup')
    current_context.add(async_job)

    # Alternatively, add will construct an Async object when given
    # a function path or reference as the first argument.
    async_job = current_context.add(
        another_function,
        [args, for, other],
        {'kwargs': 'for', 'other': 'function'},
        queue='workgroup')
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">..job_utils</span> <span class="kn">import</span> <span class="n">decode_callbacks</span>
<span class="kn">from</span> <span class="nn">..job_utils</span> <span class="kn">import</span> <span class="n">encode_callbacks</span>
<span class="kn">from</span> <span class="nn">..job_utils</span> <span class="kn">import</span> <span class="n">function_path_to_reference</span>
<span class="kn">from</span> <span class="nn">..job_utils</span> <span class="kn">import</span> <span class="n">get_function_path_and_options</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Attempt to set context on an Async that is already executing in a</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">ContextAlreadyStartedError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>context.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Furious context object.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>NOTE: Use the module's new function to get a context, do not manually
instantiate.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">id</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks_inserted</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="nb">id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span> <span class="o">=</span> <span class="n">options</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_insert_tasks</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;insert_tasks&#39;</span><span class="p">,</span> <span class="n">_insert_tasks</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_insert_tasks</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;You must provide a valid insert_tasks function.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_persistence_engine</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;persistence_engine&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Convert all Async's into tasks, then insert them into queues.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exc_type</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_tasks</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_handle_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks_inserted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ContextAlreadyStartedError</span><span class="p">(</span>
                <span class="s">&quot;This Context has already had its tasks inserted.&quot;</span><span class="p">)</span>

        <span class="n">task_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tasks_by_queue</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">queue</span><span class="p">,</span> <span class="n">tasks</span> <span class="ow">in</span> <span class="n">task_map</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_tasks</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks_inserted</span> <span class="o">=</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Return the tasks for this Context, grouped by queue.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_tasks_by_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">task_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">async</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">:</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="n">async</span><span class="o">.</span><span class="n">get_queue</span><span class="p">()</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">async</span><span class="o">.</span><span class="n">to_task</span><span class="p">()</span>
            <span class="n">task_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">task_map</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Add an Async job to this context.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>Takes an Async object or the argumnets to construct an Async
object as argumnets.  Returns the newly added Async object.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">..async</span> <span class="kn">import</span> <span class="n">Async</span>
        <span class="kn">from</span> <span class="nn">..batcher</span> <span class="kn">import</span> <span class="n">Message</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks_inserted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ContextAlreadyStartedError</span><span class="p">(</span>
                <span class="s">&quot;This Context has already had its tasks inserted.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="p">(</span><span class="n">Async</span><span class="p">,</span> <span class="n">Message</span><span class="p">)):</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">Async</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">target</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Insert this Context's tasks executing.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_tasks</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Store the context.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">persist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_persistence_engine</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s">&#39;Specify a valid persistence_engine to persist this context.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_persistence_engine</span><span class="o">.</span><span class="n">store_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Load and instantiate a Context from the persistence_engine.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">context_id</span><span class="p">,</span> <span class="n">persistence_engine</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">persistence_engine</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s">&#39;Specify a valid persistence_engine to load the context.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">persistence_engine</span><span class="o">.</span><span class="n">load_context</span><span class="p">(</span><span class="n">context_id</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Return this Context as a dict suitable for json encoding.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">import</span> <span class="nn">copy</span>

        <span class="n">options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_tasks</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s">&#39;insert_tasks&#39;</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_function_path_and_options</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_insert_tasks</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_persistence_engine</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s">&#39;persistence_engine&#39;</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_function_path_and_options</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_persistence_engine</span><span class="p">)</span>

        <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s">&#39;_tasks_inserted&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks_inserted</span><span class="p">,</span>
            <span class="s">&#39;_task_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">async</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">async</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;callbacks&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s">&#39;callbacks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">encode_callbacks</span><span class="p">(</span><span class="n">callbacks</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">options</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Return a context job from a dict output by Context.to_dict.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">context_options_dict</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">import</span> <span class="nn">copy</span>

        <span class="n">context_options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">context_options_dict</span><span class="p">)</span>

        <span class="n">tasks_inserted</span> <span class="o">=</span> <span class="n">context_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_tasks_inserted&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">task_ids</span> <span class="o">=</span> <span class="n">context_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_task_ids&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">insert_tasks</span> <span class="o">=</span> <span class="n">context_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;insert_tasks&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">insert_tasks</span><span class="p">:</span>
            <span class="n">context_options</span><span class="p">[</span><span class="s">&#39;insert_tasks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_path_to_reference</span><span class="p">(</span>
                <span class="n">insert_tasks</span><span class="p">)</span>

        <span class="n">persistence_engine</span> <span class="o">=</span> <span class="n">context_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;persistence_engine&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">persistence_engine</span><span class="p">:</span>
            <span class="n">context_options</span><span class="p">[</span><span class="s">&#39;persistence_engine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_path_to_reference</span><span class="p">(</span>
                <span class="n">persistence_engine</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>If there are callbacks, reconstitute them.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">callbacks</span> <span class="o">=</span> <span class="n">context_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;callbacks&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="n">context_options</span><span class="p">[</span><span class="s">&#39;callbacks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decode_callbacks</span><span class="p">(</span><span class="n">callbacks</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="o">**</span><span class="n">context_options</span><span class="p">)</span>

        <span class="n">context</span><span class="o">.</span><span class="n">_tasks_inserted</span> <span class="o">=</span> <span class="n">tasks_inserted</span>
        <span class="n">context</span><span class="o">.</span><span class="n">_task_ids</span> <span class="o">=</span> <span class="n">task_ids</span>

        <span class="k">return</span> <span class="n">context</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Insert a batch of tasks into the specified queue. If an error occurs</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_insert_tasks</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">transactional</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>during insertion, split the batch and retry until they are successfully
inserted.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">taskqueue</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tasks</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">taskqueue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">queue</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">transactional</span><span class="o">=</span><span class="n">transactional</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">taskqueue</span><span class="o">.</span><span class="n">TransientError</span><span class="p">,</span>
            <span class="n">taskqueue</span><span class="o">.</span><span class="n">TaskAlreadyExistsError</span><span class="p">,</span>
            <span class="n">taskqueue</span><span class="o">.</span><span class="n">TombstonedTaskError</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">_insert_tasks</span><span class="p">(</span><span class="n">tasks</span><span class="p">[:</span><span class="n">count</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">queue</span><span class="p">,</span> <span class="n">transactional</span><span class="p">)</span>
        <span class="n">_insert_tasks</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="n">count</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:],</span> <span class="n">queue</span><span class="p">,</span> <span class="n">transactional</span><span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
